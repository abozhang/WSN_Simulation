# 增强型分层无线传感器网络仿真系统

基于OMNeT++ 6.1实现的分层无线传感器网络仿真系统，具有簇头轮换、人类移动模型、增强型无线通道等功能。

## 项目主要特点

### 1. 分层网络架构
- **控制节点**：位于顶层，负责全网管理和簇头轮换
- **簇头节点**：位于中层，负责簇内通信管理和数据聚合
- **普通节点**：位于底层，执行基本的数据收集和传输任务

### 2. 簇头轮换机制
- **自动轮换**：基于节点性能指标（电池电量、丢包率、延迟等）自动选择新簇头
- **故障恢复**：当簇头失联或故障时，立即启动轮换机制
- **网络优化**：通过轮换平衡网络负载，延长整体网络寿命
- **角色切换**：节点可以在普通节点和簇头节点角色之间无缝切换

### 3. 人类移动模型
- **真实人类行为**：模拟佩戴在人身上的设备移动特性
- **多状态移动**：支持站立、行走、跑步和暂停等状态
- **状态转换**：基于概率模型进行状态之间的转换
- **区域性活动**：模拟人类在特定区域内的活动模式
- **非直线路径**：添加中间路径点，实现更真实的移动轨迹

### 4. 增强型无线通道
- **精确路径损耗**：考虑距离、频率、环境因素
- **多普勒效应**：模拟移动节点之间的频率偏移
- **阴影衰落**：实现环境障碍物造成的信号变化
- **频段差异**：模拟不同频段的传输特性
- **BER/PER计算**：基于信噪比计算误码率和丢包率
- **最大通信距离**：考虑物理层通信距离限制

### 5. 完整协议实现
- **时间同步协议**：实现基于控制节点的网络时间同步
- **高精度校时协议**：提供ns级的时间校准功能
- **态势管理协议**：收集、聚合和处理节点状态信息
- **网络管理协议**：实现角色分配和网络拓扑管理
- **寻址协议**：支持簇内和簇间节点寻址
- **波形参数配置**：实现物理层参数的动态调整

## 系统架构

```
WSN_Simulation/
├── src/
│   ├── nodes/               # 节点定义 (控制/簇头/普通节点)
│   ├── modules/             # 功能模块 (应用层/通信/时间同步等)
│   ├── protocols/           # 协议消息定义
│   ├── channels/            # 通道模型
│   ├── utils/               # 工具类
│   ├── NetworkManager.h/cc  # 网络管理器
│   ├── HumanMobility.h/cc   # 人类移动模型
│   ├── WSNChannelModel.h/cc # 增强型通道模型
│   ├── WSNSim.ini           # 仿真配置
```

## 使用方法

### 构建项目
```bash
cd WSN_Simulation
make clean
make
```

### 运行仿真
```bash
# 基本仿真（部分节点移动）
make run-basic

# 所有普通节点移动的场景
make run-mobile

# 簇头轮换测试场景
make run-rotation

# 通道模型测试场景
make run-channel
```

### 分析结果
```bash
make analyze
```

## 仿真场景

1. **Basic**：基本场景，部分节点采用人类移动模型
2. **AllMobile**：所有普通节点都采用人类移动模型
3. **MixedMobility**：混合移动模型场景
4. **ClusterHeadRotation**：测试簇头轮换功能
5. **PathLossVariations**：测试不同路径损耗指数对网络的影响
6. **CommunicationRangeTest**：测试不同通信距离对网络的影响
7. **FrequencyInterferenceTest**：测试频率干扰对网络的影响

## 簇头轮换算法

系统使用以下指标综合评分来选择簇头：

1. **电池电量** (40%)：节点剩余电量百分比
2. **丢包率** (20%)：节点的数据包传输可靠性
3. **通信延迟** (20%)：节点的数据传输延迟
4. **信号强度** (20%)：节点的信号接收质量

轮换触发条件：
- 当前簇头电池电量低于阈值
- 当前簇头的丢包率或延迟超过阈值
- 当前簇头失联（超过一定时间未响应）
- 控制节点发起的周期性轮换

## 人类移动模型参数

- **步行速度**：1.2 m/s（平均人行走速度）
- **跑步速度**：3.0 m/s（轻度跑步速度）
- **停顿时间**：均值30秒，标准差10秒
- **状态转换概率**：0.1（每次更新状态的概率）
- **活动半径**：本地活动半径50m，远距离活动半径50-200m

## 无线传感器网络通道参数

- **载波频率**：433MHz（常用的WSN频率）
- **路径损耗指数**：3.5（典型的室内/室外混合环境）
- **阴影衰落标准差**：4.0 dB
- **最大通信距离**：500m
- **接收灵敏度**：-100 dBm

## 自定义仿真

您可以修改`WSNSim.ini`文件自定义仿真参数：

```ini
# 修改网络规模
*.numClusters = 8                # 增加到8个簇
*.nodesPerCluster = 100          # 每个簇100个节点

# 修改移动模型
*.mobilityType = "randomWaypoint" # 使用随机路点模型

# 修改电池容量
*.ordinaryNodes[*].battery.initialCapacity = 2000mAh  # 增加电池容量
```

## 输出结果

仿真结果保存在`results/`目录下，包括：

1. **节点轨迹**：每个移动节点的位置随时间变化
2. **电池消耗**：各种节点的电池消耗曲线
3. **簇头切换**：簇头轮换事件记录
4. **网络性能**：丢包率、延迟等性能指标
5. **状态统计**：节点状态转换统计

## 可视化

可以使用OMNeT++的Qtenv环境运行仿真以获得可视化效果：

```bash
make run-gui
```

这将显示节点移动、通信过程和网络拓扑结构的动态变化。